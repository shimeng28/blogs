---
title: 记一次前端的前后端开发
date: 2019-07-10 21:42:55
tags:
---

### 背景

由于做的项目是影院商家系统，因此涉及到了大量的第三方的接口。在之前是一部分接口是第三方通过HTTP接口实现的，因此浏览器可以直接通过网络请求，另一部分的就是通过Thrift直连，对于这种方式，之前的做法是我们这边的后端和第三方的人员联调沟通，之后给前端提供HTTP接口。然后呢，这段时候正好公司那边开始推Thrift直连的这种方式，因此需要逐步将HTTP接口改为Thrift接口。

于是这次的需求我便向其他的同事要求希望由我来处理和第三方的对接，省去了我们这边的Java后端的介入。我这边就是通过node去请求第三方的数据，node提供接口给浏览器使用。今天呢算是开发联调结束，总耗时6天，按照之前的排期，如果是我们这边的后端介入的话，总开发时间是5天，联调需要1-2天。其实发现好像没有什么优势，其实如果除去第一次这种开发模式，在Thrift接口调试上消耗的时候来算的话，真正的开发联调时间大概5天能搞定。

### 业务内容

整个来说就是前端使用hooks开发页面，数据组提供了3个新接口，针对前端来说两个接口请求就够了，因此将会员卡名称和种类的接口合并了，剩下一个就是根据条件查询会员卡订单的接口。也需要有个导出excel文件的接口。业务逻辑没什么可说的。导出接口就是将返回的数据生成excel文件，之后返回给前端。这里面实现的方案是通过GitHub查找了node中生成excel的包，发现了一个star比较高的node-xlsx，看了下使用，发现能满足本次业务需求。于是便按照说明接入，但是发现它生成的是一个Buffer，如果想要将文件传递给前端，比较合适的方法还是生成一个readable Stream，通过管道pipe给response就可以了。代码大致为：

```js
const xlsx = require('node-xlsx');
const { Readable } = require('stream');

const data = [['第一列', '第二列', '第三列'], [1, 2, 3]];
const buffer = xlsx.build([{name: "mySheetName", data: data}]);

const xlsxStream = new Readable();
xlsxStream.push(buffer);
xlsxStream.push(null);


this.set('Content-Disposition', `attachment;filename=${xslName}`);
this.body = xlsxStream;
```

前端通过window.open打开连接

```js
window.open(url, 'Window_Name');
```

由于第三方数据组没有提供test环境，本地没有办法直连staging机器，那么为了调试，我们这边是要解决这个问题的。
  
解决思路就是在前端的staging机器上开一个进程作为数据的转发，请求thrift。本地另开一个服务器监听端口然后转发给staging机器。为了减少耦合，本地另起一个转发脚本，将数据组提供的机器IP和端口号转发到本地另开的服务器上。本地请求thrift接口时，通过服务发现，请求的机器是数据组提供的IP和端口号。只要本地开发过程中执行转发脚本就行。
    

### 个人思考

如果说按照这种方式开发的化，相当于是java后端只是作为数据的提供，并不参与到业务的开发中了。而前端的工作量相当于是加倍了，但是三方联调变成了两方联调，显著提高了项目的开发效率。这种情况下前端就直接把控了整个业务需求的开发，谈不上好坏，通过多做了工作成为了项目的主导者。个人看法对于大量设计跨部门的业务需求，直接节省掉自己这边的java后端是一件提高效率的事情，对于像经常变动需求的业务来说也是一样的。当然了做的多，对前端的要求也是上了一个台阶。但是对个人的锻炼也是不一样的。
